name: Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - prod
        default: 'prod'

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: prod  # Uses GitHub environment with AWS_ACCOUNT_ID and AWS_REGION variables

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Set up SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-Deploy-${{ github.run_id }}

      - name: Verify AWS identity
        run: |
          aws sts get-caller-identity

      - name: Validate SAM template
        run: sam validate --lint

      - name: SAM build
        run: sam build --cached

      - name: SAM deploy
        run: |
          sam deploy \
            --stack-name secrets-replicator-prod \
            --region ${{ vars.AWS_REGION }} \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --capabilities CAPABILITY_IAM \
            --resolve-s3 \
            --parameter-overrides \
              SourceSecretPattern='*' \
              DestinationRegion=${{ vars.AWS_REGION }} \
              TransformMode='sed' \
              LogLevel='INFO' \
              EnableMetrics='true' \
            --tags \
              Environment=prod \
              Project=SecretsReplicator \
              ManagedBy=GitHubActions \
              Version=${{ github.ref_name }}

      - name: Get stack outputs
        id: stack-outputs
        run: |
          FUNCTION_ARN=$(aws cloudformation describe-stacks \
            --stack-name secrets-replicator-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`FunctionArn`].OutputValue' \
            --output text)

          TOPIC_ARN=$(aws cloudformation describe-stacks \
            --stack-name secrets-replicator-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`AlertTopicArn`].OutputValue' \
            --output text)

          echo "function_arn=$FUNCTION_ARN" >> $GITHUB_OUTPUT
          echo "topic_arn=$TOPIC_ARN" >> $GITHUB_OUTPUT

          echo "### Deployment Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stack Name:** secrets-replicator-prod" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ vars.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Function ARN:** $FUNCTION_ARN" >> $GITHUB_STEP_SUMMARY
          echo "**Alert Topic ARN:** $TOPIC_ARN" >> $GITHUB_STEP_SUMMARY

      - name: Run smoke tests
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          echo "Running smoke tests..."

          # Check Lambda function exists and is active
          aws lambda get-function --function-name secrets-replicator-prod-replicator

          # Check EventBridge rule is enabled
          RULE_STATE=$(aws events describe-rule \
            --name secrets-replicator-prod-SecretChangeRule \
            --query 'State' \
            --output text)

          if [ "$RULE_STATE" != "ENABLED" ]; then
            echo "❌ EventBridge rule is not enabled"
            exit 1
          fi

          echo "✅ Smoke tests passed"

      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: 'prod',
              required_contexts: [],
              auto_merge: false,
              description: 'Deployment to AWS prod',
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              description: 'Successfully deployed to prod',
              environment_url: 'https://console.aws.amazon.com/lambda/home?region=${{ vars.AWS_REGION }}#/functions/secrets-replicator-prod-replicator',
            });

      - name: Post deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** prod" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ vars.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Account ID:** ${{ vars.AWS_ACCOUNT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Stack:** secrets-replicator-prod" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Subscribe to SNS topic for alerts" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor CloudWatch Logs" >> $GITHUB_STEP_SUMMARY
          echo "3. Create test secret to verify replication" >> $GITHUB_STEP_SUMMARY
