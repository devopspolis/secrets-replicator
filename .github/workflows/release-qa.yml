name: Release to QA

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Semantic version (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy-qa:
    name: Build Once and Deploy to QA
    runs-on: ubuntu-latest
    environment: qa

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install PyYAML
        run: pip3 install pyyaml

      - name: Set up SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-QA-${{ github.run_id }}

      - name: Extract version from release tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
            VERSION="${TAG_NAME#v}"  # Strip 'v' prefix
            echo "Source: GitHub Release tag ${TAG_NAME}"
          else
            VERSION="${{ github.event.inputs.version }}"
            echo "Source: Manual input"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          echo "### Building Version: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** QA" >> $GITHUB_STEP_SUMMARY

      - name: Verify AWS identity
        run: |
          aws sts get-caller-identity
          echo "**Account:** ${{ vars.AWS_ACCOUNT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ vars.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY

      - name: Build application (build once)
        run: |
          echo "### Building Application..." >> $GITHUB_STEP_SUMMARY
          sam build

      - name: Package application (upload to S3)
        run: |
          # Use version-specific S3 prefix for this build
          S3_BUCKET="secrets-replicator-builds-${{ vars.AWS_REGION }}"
          S3_PREFIX="releases/${{ steps.version.outputs.version }}"

          # Create bucket if it doesn't exist
          if ! aws s3 ls "s3://${S3_BUCKET}" --region ${{ vars.AWS_REGION }} 2>/dev/null; then
            echo "Creating builds bucket: ${S3_BUCKET}"
            if [ "${{ vars.AWS_REGION }}" = "us-east-1" ]; then
              aws s3 mb "s3://${S3_BUCKET}" --region ${{ vars.AWS_REGION }}
            else
              aws s3api create-bucket \
                --bucket "${S3_BUCKET}" \
                --region ${{ vars.AWS_REGION }} \
                --create-bucket-configuration LocationConstraint=${{ vars.AWS_REGION }}
            fi

            # Enable versioning
            aws s3api put-bucket-versioning \
              --bucket "${S3_BUCKET}" \
              --versioning-configuration Status=Enabled \
              --region ${{ vars.AWS_REGION }}
          fi

          echo "### Packaging Application..." >> $GITHUB_STEP_SUMMARY

          # Package with version-specific prefix
          sam package \
            --template-file .aws-sam/build/template.yaml \
            --output-template-file packaged-qa.yaml \
            --s3-bucket "${S3_BUCKET}" \
            --s3-prefix "${S3_PREFIX}" \
            --region ${{ vars.AWS_REGION }}

          echo "**Package Location:** s3://${S3_BUCKET}/${S3_PREFIX}/" >> $GITHUB_STEP_SUMMARY

          # Store S3 location for prod deployment
          echo "S3_BUCKET=${S3_BUCKET}" >> $GITHUB_ENV
          echo "S3_PREFIX=${S3_PREFIX}" >> $GITHUB_ENV

      - name: Restore SAR metadata with version
        run: |
          $(which python3) -c "
import yaml
import sys

# Read original template
with open('template.yaml', 'r') as f:
    original = yaml.safe_load(f)

# Read packaged template
with open('packaged-qa.yaml', 'r') as f:
    packaged = yaml.safe_load(f)

# Copy and update Metadata section
if 'Metadata' in original:
    packaged['Metadata'] = original['Metadata']
    # Override version
    if 'AWS::ServerlessRepo::Application' in packaged['Metadata']:
        packaged['Metadata']['AWS::ServerlessRepo::Application']['SemanticVersion'] = '${{ steps.version.outputs.version }}'
        print(f'Version set to: ${{ steps.version.outputs.version }}', file=sys.stderr)

# Write back
with open('packaged-qa.yaml', 'w') as f:
    yaml.dump(packaged, f, default_flow_style=False, sort_keys=False)
"

      - name: Store packaged template as artifact
        uses: actions/upload-artifact@v4
        with:
          name: packaged-template-${{ steps.version.outputs.version }}
          path: packaged-qa.yaml
          retention-days: 90

      - name: Deploy to QA environment
        run: |
          echo "### Deploying to QA..." >> $GITHUB_STEP_SUMMARY

          sam deploy \
            --template-file packaged-qa.yaml \
            --stack-name secrets-replicator-qa \
            --region ${{ vars.AWS_REGION }} \
            --capabilities CAPABILITY_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --tags \
              Environment=qa \
              Version=${{ steps.version.outputs.version }} \
              ManagedBy=GitHubActions

      - name: Get QA stack outputs
        run: |
          echo "### QA Deployment Complete! âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          aws cloudformation describe-stacks \
            --stack-name secrets-replicator-qa \
            --region ${{ vars.AWS_REGION }} \
            --query 'Stacks[0].Outputs' \
            --output table >> $GITHUB_STEP_SUMMARY

      - name: Create release summary
        run: |
          echo "## ðŸŽ‰ QA Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build Package:** s3://${S3_BUCKET}/${S3_PREFIX}/" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** packaged-template-${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Test in QA environment" >> $GITHUB_STEP_SUMMARY
          echo "2. When ready, trigger 'Release to Prod' workflow with version \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. The SAME package will be deployed to Prod (no rebuild)" >> $GITHUB_STEP_SUMMARY
