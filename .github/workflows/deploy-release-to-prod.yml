name: Release to Prod

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to promote from QA (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set_environment.outputs.environment }}
      version: ${{ steps.set_version.outputs.version }}
      s3_bucket: ${{ steps.set_s3.outputs.s3_bucket }}
      s3_uri: ${{ steps.set_s3.outputs.s3_uri }}

    steps:
      - name: Set environment
        id: set_environment
        run: echo "environment=production" >> $GITHUB_OUTPUT

      - name: Set version
        id: set_version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          # Strip 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          echo "### Promoting to Production" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY

      - name: Set S3 configuration
        id: set_s3
        run: |
          echo "s3_bucket=secrets-replicator-builds" >> $GITHUB_OUTPUT
          echo "s3_uri=s3://secrets-replicator-builds/releases/${{ steps.set_version.outputs.version }}/packaged-qa.yaml" >> $GITHUB_OUTPUT

  promote-from-qa:
    name: Promote Package from QA
    needs: setup
    runs-on: ubuntu-latest
    environment: qa
    outputs:
      artifact_name: ${{ steps.set_artifact.outputs.artifact_name }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-Prod-Promote-${{ github.run_id }}

      - name: Download package from S3
        run: |
          S3_URI="${{ needs.setup.outputs.s3_uri }}"
          echo "### Downloading Package from QA..." >> $GITHUB_STEP_SUMMARY
          echo "**Source:** ${S3_URI}" >> $GITHUB_STEP_SUMMARY

          aws s3 cp "${S3_URI}" packaged-qa.yaml --region ${{ vars.AWS_REGION }}

          echo "âœ… Package retrieved from QA S3" >> $GITHUB_STEP_SUMMARY

      - name: Set artifact name
        id: set_artifact
        run: echo "artifact_name=packaged-template-${{ needs.setup.outputs.version }}" >> $GITHUB_OUTPUT

      - name: Upload as GitHub artifact
        uses: actions/upload-artifact@v4
        with:
          name: packaged-template-${{ needs.setup.outputs.version }}
          path: packaged-qa.yaml
          retention-days: 90

  approval:
    name: Approval
    needs: [setup, promote-from-qa]
    runs-on: ubuntu-latest
    environment: approval
    steps:
      - name: Approval
        run: echo "Approved"

  deploy-to-prod:
    name: Deploy to Production
    needs: [setup, promote-from-qa, approval]
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Set up SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-Prod-Deploy-${{ github.run_id }}

      - name: Verify AWS identity
        run: |
          aws sts get-caller-identity
          echo "### Deploying to Production" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.setup.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Account:** ${{ vars.AWS_ACCOUNT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ vars.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY

      - name: Download package from GitHub artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.promote-from-qa.outputs.artifact_name }}

      - name: Verify package
        run: |
          if [ ! -f packaged-qa.yaml ]; then
            echo "âŒ ERROR: Package not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "### Using QA Package" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Package retrieved from QA account (via environment switching)" >> $GITHUB_STEP_SUMMARY

      - name: Re-package for Production
        run: |
          echo "### Re-packaging for Production..." >> $GITHUB_STEP_SUMMARY
          echo "This uploads Lambda code to prod S3 bucket and updates CodeUri" >> $GITHUB_STEP_SUMMARY

          sam package \
            --template-file packaged-qa.yaml \
            --output-template-file packaged-prod.yaml \
            --s3-bucket secrets-replicator-builds-prod \
            --region ${{ vars.AWS_REGION }}

          echo "âœ… Template re-packaged with prod S3 URIs" >> $GITHUB_STEP_SUMMARY

      - name: Deploy to Production
        run: |
          echo "### Deploying to Production..." >> $GITHUB_STEP_SUMMARY

          sam deploy \
            --template-file packaged-prod.yaml \
            --stack-name secrets-replicator-prod \
            --region ${{ vars.AWS_REGION }} \
            --capabilities CAPABILITY_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Environment=prod \
            --tags \
              Environment=prod \
              Version=${{ needs.setup.outputs.version }} \
              ManagedBy=GitHubActions

      - name: Get Production stack outputs
        run: |
          echo "### Production Deployment Complete! âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          aws cloudformation describe-stacks \
            --stack-name secrets-replicator-prod \
            --region ${{ vars.AWS_REGION }} \
            --query 'Stacks[0].Outputs' \
            --output table >> $GITHUB_STEP_SUMMARY

      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Production Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.setup.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Stack:** secrets-replicator-prod" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ vars.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Validate functionality in production environment" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor CloudWatch metrics and alarms" >> $GITHUB_STEP_SUMMARY
          echo "3. When ready to publish publicly, trigger 'Publish to SAR' workflow" >> $GITHUB_STEP_SUMMARY
